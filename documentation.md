# Документация проекта: ERP Система учета нефтепродуктов

## Обзор проекта
Система предназначена для комплексного учета операций с нефтепродуктами, включая закупки, хранение, логистику, оптовую реализацию и заправку воздушных судов.

## Технологический стек
- **Frontend**: React 18, Vite, Tailwind CSS, Shadcn UI, TanStack Query, Wouter
- **Backend**: Node.js, Express, TypeScript
- **База данных**: PostgreSQL с Drizzle ORM
- **Аутентификация**: Passport.js с сессиями

## Структура проекта

### Frontend (`client/src/`)

#### Компоненты (`components/`)
- `ui/` - Базовые UI компоненты Shadcn (button, card, dialog, form и т.д.)
- `app-sidebar.tsx` - Боковое меню навигации
- `theme-toggle.tsx` - Переключатель темы (светлая/темная)
- `audit-panel.tsx` - Панель истории изменений
- `entity-actions-menu.tsx` - Контекстное меню действий для сущностей
- `export/` - Компоненты экспорта данных в Excel

#### Страницы (`pages/`)

**Дашборд (`dashboard/`)**
- Настраиваемый дашборд с виджетами
- Поддержка drag-and-drop для перемещения виджетов
- Изменение ширины (1/3, 1/2, полная) и высоты виджетов
- Система шаблонов для сохранения конфигураций

**Операции:**
- `opt/` - Оптовая торговля
- `refueling/` - Заправка воздушных судов
- `movement/` - Перемещения между складами
- `exchange/` - Обмен нефтепродуктами
- `delivery/` - Доставка

**Финансы (`finance/`):**
- `cashflow-page.tsx` - Движение денежных средств
- `payment-calendar-page.tsx` - Платежный календарь
- `price-calculation-page.tsx` - Расчет цен

**Отчеты (`reports/`):**
- Ежедневные отчеты
- Аналитика
- Бюджет
- Госконтракты
- Управленческая отчетность

**Справочники (`directories/`):**
- Базы
- Поставщики
- Покупатели
- Логистические компании

**Склады (`warehouses/`):**
- Управление складами
- Учет остатков
- Карточки складов

**Администрирование (`admin/`):**
- Пользователи
- Роли и права доступа
- Настройки виджетов

### Backend (`server/`)

#### Модульная архитектура (`modules/`)
Каждый модуль содержит:
- `entities/` - Определения схем Drizzle
- `routes/` - API эндпоинты Express
- `storage/` - Слой доступа к данным

**Модули:**
- `audit/` - Аудит и откат изменений
- `analytics/` - Аналитические запросы
- `bases/`, `suppliers/`, `customers/`, `logistics/` - Справочники
- `opt/`, `refueling/`, `movement/`, `exchange/`, `delivery/` - Операции
- `warehouses/` - Склады и остатки
- `finance/` - Финансовые операции
- `dashboard/` - Конфигурация дашборда
- `export/` - Экспорт данных
- `users/` - Пользователи и авторизация

### Общее (`shared/`)
- `schema.ts` - Единая схема базы данных (Drizzle)
- `constants.ts` - Общие константы

## Ключевые функции

### 1. Кастомизируемый дашборд
- **Drag-and-Drop**: Перетаскивайте виджеты за иконку захвата (⋮⋮) для изменения порядка
- **Изменение размера**: Тяните нижнюю границу виджета для изменения высоты
- **Управление шириной**: Кнопки 1/3, 1/2, 100% для выбора ширины виджета
- **Кнопки перемещения**: Стрелки вверх/вниз для точного позиционирования
- **Удаление**: Кнопка X для удаления виджета
- **Шаблоны**: Сохраняйте конфигурации как шаблоны для быстрого переключения
- **Автосохранение**: Изменения сохраняются автоматически через 2 секунды

### 2. Система аудита
- Логирование всех изменений данных
- История изменений для каждой сущности
- Возможность просмотра предыдущих версий
- Откат (rollback) к предыдущему состоянию

### 3. Автоматические расчеты
- Себестоимость операций
- Налоги и акцизы
- Маржинальность сделок
- Остатки на складах

### 4. Экспорт данных
- Экспорт в Excel
- Настраиваемые колонки
- Фильтрация данных

## API Эндпоинты

### Дашборд
- `GET /api/dashboard/configuration` - Получить конфигурацию
- `POST /api/dashboard/configuration` - Сохранить конфигурацию
- `GET /api/dashboard/widgets/available` - Список доступных виджетов
- `GET /api/dashboard/templates` - Список шаблонов
- `POST /api/dashboard/templates` - Создать шаблон

### Операции
- `GET/POST /api/opt` - Оптовая торговля
- `GET/POST /api/refueling` - Заправка ВС
- `GET/POST /api/movement` - Перемещения
- `GET/POST /api/exchange` - Обмен

### Справочники
- `GET/POST /api/bases` - Базы
- `GET/POST /api/suppliers` - Поставщики
- `GET/POST /api/customers` - Покупатели
- `GET/POST /api/logistics` - Логистика

### Финансы
- `GET/POST /api/cashflow` - Движение ДС
- `GET/POST /api/payment-calendar` - Платежный календарь
- `GET/POST /api/price-calculation` - Расчет цен

## База данных

### Основные таблицы
- `users`, `roles` - Пользователи и роли
- `warehouses`, `warehouse_transactions` - Склады и транзакции
- `opt_deals` - Оптовые сделки
- `aircraft_refueling` - Заправка ВС
- `movement_deals` - Перемещения
- `exchange_deals` - Обмен
- `delivery` - Доставка
- `prices` - Цены
- `bases`, `suppliers`, `customers`, `logistics_companies` - Справочники
- `audit_log` - Журнал аудита
- `dashboard_configurations`, `widget_definitions`, `dashboard_templates` - Дашборд

## Запуск проекта

```bash
npm run dev
```

Сервер запускается на порту 5000. Frontend и Backend работают на одном порту через Vite middleware.

## Миграции базы данных

Миграции находятся в папке `migrations/`. Применяются автоматически при запуске через Drizzle ORM.

Система автоматических миграций:

- Создал скрипт server/migrate.ts для программного выполнения миграций (схема + данные).
- Обновил server/index.ts, чтобы миграции запускались автоматически при старте.
- Исправил потенциальный конфликт с таблицей сессий.

Теперь для применения любых изменений (включая миграции данных) вам нужно:

- Создать миграцию: npx drizzle-kit generate
- Если нужна миграция данных — добавить SQL/JS код в созданный файл в папке migrations/.
- Перезапустить приложение или выставить переменную окружения RUN_MIGRATIONS=true.

Для локального развертывания с бэкапом:

- Создайте пустую БД.
- Прогоните миграции (это создаст структуру).
- Накатите ваш бэкап данных.

(Чек-лист) Для применения изменений (схема или данные):

- Выполните: npx drizzle-kit generate.
- Если нужно добавить данные (роли, настройки): откройте созданный .sql файл в папке migrations и добавьте ваши INSERT команды в конец.
- Перезапустите приложение. Миграция применится автоматически.

Для локального развертывания с вашим бэкапом:

- Создайте пустую БД.
- Запустите приложение (оно само создаст все таблицы через миграции).
- Загрузите ваш бэкап данных в созданные таблицы.
  
## Переменные окружения

- `DATABASE_URL` - URL подключения к PostgreSQL
- `SESSION_SECRET` - Секрет для сессий (генерируется автоматически)